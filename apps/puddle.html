<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8" />
<title>Icepuddle</title>
<link rel="stylesheet" href="styles.css">
<link rel="shortcut icon" type="image/png" href="favicon.png">
<script src="https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.4.12/src-min-noconflict/ace.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<style type="text/css" media="screen">
    .ace_editor {
        border: 1px solid lightgray;
        font-size: 100%;
        height: 600px;
        margin: auto;
        min-width: 600px;
    }
</style>
</head>

<body>
<h1>Icepuddle</h1>

<p>This is still experimental.</p>

<h2>Useful links</h2>

<ul>
    <li><a href="https://github.com/HighDiceRoller/icepool">Icepool Github.</a></li>
    <li><a href="./apidoc/icepool.html">API documentation.</a></li>
    <li><a href="./notebooks/lab/index.html">JupyterLite distribution.</a> Contains a collection of example notebooks.</li>
</ul>

<div class="row">
    <div class="col" id="editor"></div>
    <div class="col" style="height: 600px; overflow: auto;">
        <h3 style="margin-top:0;">Output</h3>
        <div id="output" style="white-space: pre; font-family: monospace;"></div>
        <h3>Error</h3>
        <div id="error" style="color: red; white-space: pre; font-family: monospace;"></div>
    </div>
</div>

<div>
    <button id="run">Run</button>
</div>

<canvas id="chart"></canvas>

<script type="text/javascript">
// Setup editor.
var editor = ace.edit("editor");
editor.setTheme("ace/theme/monokai");
editor.session.setMode("ace/mode/python");

let initial_code = 'import icepool\n\n';
let searchParams = new URLSearchParams(window.location.search);
let url_code = searchParams.get('code');
if (url_code) {
    initial_code = atob(url_code);
}
editor.setValue(initial_code, 1);

// Setup chart.
var chartContext = document.getElementById('chart').getContext('2d');
var chart = new Chart(chartContext, {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            {
                label: 'test',
            },
        ],
    },
    options: {
        responsive: true,
        interaction: {
            intersect: false,
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Outcome',
                },
            },
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Probability (%)',
                },
            },
        },
        plugins: {
            title: {
                fullSize: true,
                display : true,
                font: {
                    size: 36,
                },
            },
        },
    },
});

function setLoadingText(text) {
    console.log(text);
    let loadingText = text.match(/Loading \w+/);
    if (!loadingText) {
        return;
    }
    chart.options.plugins.title.text = loadingText[0];
    chart.update();
}


async function initPyodide(){
    setLoadingText('Loading pyodide')
    let pyodide = await loadPyodide({
        indexURL : "https://cdn.jsdelivr.net/pyodide/v0.20.0/full/",
        stdout: (text) => {document.getElementById("output").textContent += text + '\n';},
        stderr: (text) => {document.getElementById("error").textContent += text + '\n';}
    });
    
    await pyodide.loadPackage(["micropip"], setLoadingText);
    
    setLoadingText('Loading icepool')
    await pyodide.runPythonAsync(`import micropip;await micropip.install('icepool==0.17.1')`)
    chart.options.plugins.title = {
        text: "",
        fullSize: false,
        display : false,
    };
    chart.update();
    return pyodide;
}

let pyodideReadyPromise = initPyodide();

async function run() {
    let pyodide = await pyodideReadyPromise;
    
    document.getElementById("output").textContent = "";
    document.getElementById("error").textContent = "";
    
    let code = editor.getValue();
    history.replaceState(null, "", "?code=" + btoa(code));
    try {
        pyodide.runPython(code);
    } catch (err) {
        document.getElementById("error").textContent += err;
    }
}

document.getElementById("run").addEventListener("click", run);

run();

</script>

</body>
